<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Document</title>
        <style media="screen">
            /*label,*/
            select,
            option,
            input {
                padding: 2px;
                height: 1.5em;
                border: 1px solid gray;
                border-radius: 3px;
            }

            button {
                padding: 5px 10px;
                border-radius: 3px;
                border: 1px solid gray;
                /*height: 2em;*/
            }

            select {
                height: 2.5em;
            }

        </style>
    </head>
    <body>
        <label for="dataid">資料編號</label>
            <select name="dataid" id="dataid">
                <option value="W-C0034-001">颱風消息與警報-颱風警報</option>
                <option value="W-C0034-002">颱風消息與警報-颱風消息</option>
                <option value="W-C0034-003">颱風消息與警報-颱風侵襲機率</option>
                <option value="W-C0034-004">颱風消息與警報-颱風路徑</option>
                <option value="F-C0034-005">颱風期間各警戒地區風力預測</option>
                <option value="F-C0034-006">颱風期間各地區24小時雨量預測</option>
                <!-- <option value="F-D0047-001">宜蘭縣未來2天天氣預報</option>
                <option value="F-D0047-005">桃園市未來2天天氣預報</option>
                <option value="F-D0047-009">新竹縣未來2天天氣預報</option>
                <option value="F-D0047-013">苗栗縣未來2天天氣預報</option>
                <option value="F-D0047-017">彰化縣未來2天天氣預報</option>
                <option value="F-D0047-021">南投縣未來2天天氣預報</option>
                <option value="F-D0047-025">雲林縣未來2天天氣預報</option>
                <option value="F-D0047-029">嘉義縣未來2天天氣預報</option>
                <option value="F-D0047-033">屏東縣未來2天天氣預報</option>
                <option value="F-D0047-037">臺東縣未來2天天氣預報</option>
                <option value="F-D0047-041">花蓮縣未來2天天氣預報</option>
                <option value="F-D0047-045">澎湖縣未來2天天氣預報</option>
                <option value="F-D0047-049">基隆市未來2天天氣預報</option>
                <option value="F-D0047-053">新竹市未來2天天氣預報</option>
                <option value="F-D0047-057">嘉義市未來2天天氣預報</option>
                <option value="F-D0047-061">臺北市未來2天天氣預報</option>
                <option value="F-D0047-065">高雄市未來2天天氣預報</option>
                <option value="F-D0047-069">新北市未來2天天氣預報</option>
                <option value="F-D0047-073">臺中市未來2天天氣預報</option>
                <option value="F-D0047-077">臺南市未來2天天氣預報</option>
                <option value="F-D0047-081">連江縣未來2天天氣預報</option>
                <option value="F-D0047-085">金門縣未來2天天氣預報</option> -->
                <option value="F-D0047-089">台灣未來2天天氣預報</option>
                <option value="W-C0033-001">天氣特報-各別縣市地區目前之天氣警特報情形</option>
                <option value="W-C0033-002">天氣特報-各別天氣警特報之內容及所影響之區域</option>
                <option value="W-C0033-003">天氣特報-豪大雨特報</option>
            </select>
        <label for="authorizationkey">授權碼</label><input type="text" id="authorizationkey" value="">
        <button onclick="send()">click</button>
        <p><a href="http://typhoon.ws/learn/reference/stop_working_rule">政府發布的停班停課</a></p>
        <ul>
            <li>
                風力
                <ul>
                    <li>颱風暴風半徑於四小時內可能經過的地區</li>
                    <li>平均風力達到七級風</li>
                    <li>陣風達到十級風</li>
                </ul>
            </li>
            <li>
                雨量
                <ul>
                    <li><a href="http://law.moj.gov.tw/Law/law_getfile.ashx?FileId=0000124126" target="_blank">各縣市「未來24小時累積雨量預測/毫米」標準表</a></li>
                    <li>以交通部中央氣象局發布之各該地區24小時雨量預測值，作為決定及通報依據。</li>
                    <li>「實際觀測」雨量值係以交通部中央氣象局於各縣市行政區所設雨量站實際測得24小時累積雨量值，作為決定及通報依據。</li>
                </ul>
            </li>
            <li>
                土石流
                <ul>
                    <li><a href="http://246.swcb.gov.tw/debrisInfo/Debris.aspx" target="_blank">各縣市「地區降雨量達到土石流警戒基準值」標準表</a></li>
                </ul>
            </li>
        </ul>
        <pre id="content"></pre>
        <script
          src="https://code.jquery.com/jquery-3.2.1.js"
          integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE="
          crossorigin="anonymous"></script>


        <script type="text/javascript">
        //'CWB-81E3A4E0-7B70-47EF-B53C-148079419530';


        function getXmlContent (tagName) {
            return this.querySelector(tagName).textContent.trim();
        }

        function getXmls(nodeName) {
            return [...this.querySelectorAll(nodeName)];
        }

        function isNodeEq (tagName, eqValue) {
            this.getText = getXmlContent;
            return this.getText(tagName) == eqValue;
        }


        function send () {
            // const dataid = document.querySelector('#dataid').value;
            // const authorizationkey = document.querySelector('#authorizationkey').value;
            // const url = `http://opendata.cwb.gov.tw/opendataapi?dataid=${dataid}&authorizationkey=${authorizationkey}`
            // const url = `./data.xml`
            const url = 'https://cors-anywhere.herokuapp.com/opendata.cwb.gov.tw/opendataapi?dataid=F-D0047-089&authorizationkey=CWB-81E3A4E0-7B70-47EF-B53C-148079419530';

            var dataset = {}
            function responsed (data) {
                data.getText = getXmlContent;
                data.getList = getXmls;

                dataset.title = data.getText('datasetDescription');
                dataset.updatetime = data.getText('update');
                const localtions = data.getList('location');
                dataset.localtions = localtions.map(function (location) {
                    location.getText = getXmlContent;

                    let weathers = [...location.querySelectorAll('weatherElement')];
                    weathers = weathers.filter(function (weather) {
                        weather.compare = isNodeEq;
                        return weather.compare('elementName', 'Wind');
                    })

                    weathers = weathers.map(function (wind) {
                        wind.getList = getXmls;
                        let times = wind.getList('time');

                        times = times.map(function (time) {
                            time.getText = getXmlContent;
                            time.getList = getXmls;

                            let params = time.getList('parameter');
                            let speeds = params.filter(function (param) {
                                param.compare = isNodeEq;
                                return param.compare('parameterName', '風速');
                            })

                            speeds = speeds.map (function (speed) {
                                speed.getText = getXmlContent;
                                return {
                                    name: speed.getText('parameterName'),
                                    value: speed.getText('parameterValue')
                                }
                            })

                            return {
                                time: time.getText('dataTime'),
                                speed: speeds[0].value
                            }
                        })

                        return times
                    })

                    return {
                        name: location.getText('locationName'),
                        winds: weathers[0]
                    }
                })
                console.log(dataset);
                document.querySelector("#content").innerHTML = JSON.stringify(dataset);
            }

            $.ajax({
                url: url,
                async: false,
                success: responsed
            });



            // var xhttp = new XMLHttpRequest();
            // xhttp.onreadystatechange = function() {
            //     // console.log(this);
            //     if (this.readyState == 4 && this.status == 200) {
            //         // console.log(this.responseText);
            //         responsed(this.responseText);
            //     }
            // };
            //
            // xhttp.open("GET", url, false);
            // xhttp.send();
            // if (xhttp.readyState == 4 && xhttp.status == 200) {
            //     console.log(xhttp.responseText);
            //     document.querySelector("#content").innerHTML = xhttp.responseText.toString();
            // }
        }

        </script>
    </body>
</html>
